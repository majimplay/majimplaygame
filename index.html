<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login com Google - PlayFab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f3f4f6; /* Cinza claro Tailwind */
        }
        .container {
            background-color: white;
            padding: 2rem; /* Equivalente a p-8 */
            border-radius: 0.5rem; /* Equivalente a rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Equivalente a shadow-md */
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .google-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem; /* Equivalente a py-3 px-6 */
            border: 1px solid #d1d5db; /* Cinza Tailwind */
            border-radius: 0.375rem; /* Equivalente a rounded-md */
            background-color: white;
            color: #374151; /* Cinza escuro Tailwind */
            font-weight: 500; /* Equivalente a font-medium */
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 1rem; /* Equivalente a mt-4 */
        }
        .google-btn:hover {
            background-color: #f9fafb; /* Cinza muito claro Tailwind */
        }
        .google-icon {
            width: 1.25rem; /* Equivalente a w-5 */
            height: 1.25rem; /* Equivalente a h-5 */
            margin-right: 0.75rem; /* Equivalente a mr-3 */
        }
        .user-panel {
            display: none; /* Oculto por padrão */
            margin-top: 1.5rem; /* Equivalente a mt-6 */
            padding-top: 1.5rem; /* Equivalente a pt-6 */
            border-top: 1px solid #e5e7eb; /* Cinza claro Tailwind */
        }
        .user-avatar {
            width: 5rem; /* Equivalente a w-20 */
            height: 5rem; /* Equivalente a h-20 */
            border-radius: 9999px; /* Equivalente a rounded-full */
            margin: 0 auto 1rem; /* Centraliza e adiciona margem inferior */
            object-fit: cover;
            border: 2px solid #e5e7eb;
        }
         .user-avatar-placeholder {
            width: 5rem; /* Equivalente a w-20 */
            height: 5rem; /* Equivalente a h-20 */
            border-radius: 9999px; /* Equivalente a rounded-full */
            margin: 0 auto 1rem; /* Centraliza e adiciona margem inferior */
            background-color: #d1d5db; /* Cinza Tailwind */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            color: #6b7280; /* Cinza médio Tailwind */
            border: 2px solid #e5e7eb;
        }
        .logout-btn {
            background-color: #ef4444; /* Vermelho Tailwind */
            color: white;
            padding: 0.5rem 1rem; /* Equivalente a py-2 px-4 */
            border-radius: 0.375rem; /* Equivalente a rounded-md */
            cursor: pointer;
            margin-top: 1rem; /* Equivalente a mt-4 */
            border: none;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .logout-btn:hover {
            background-color: #dc2626; /* Vermelho mais escuro Tailwind */
        }
        .loading-spinner {
            border: 4px solid #f3f4f6; /* Cinza claro */
            border-top: 4px solid #3b82f6; /* Azul */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 20px auto 0; /* Centraliza e adiciona margem superior */
            display: none; /* Oculto por padrão */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-2xl font-semibold mb-4">Login com Google</h2>

        <button id="google-login-btn" class="google-btn" onclick="handleGoogleLogin()">
            <img src="https://developers.google.com/identity/images/g-logo.png"
                 alt="Google logo"
                 class="google-icon">
            Continuar com Google
        </button>

        <div id="user-panel" class="user-panel">
             <div id="avatar-container">
                 <div id="user-avatar-placeholder" class="user-avatar-placeholder">?</div>
                 <img id="user-avatar" class="user-avatar" alt="User Avatar" style="display: none;">
            </div>
            <h3 class="text-xl font-medium mb-1">Bem-vindo(a)!</h3>
            <p class="text-gray-600 mb-4">ID: <span id="user-playfab-id" class="font-mono text-sm"></span></p>
            <p class="text-gray-800 text-lg font-semibold mb-4" id="user-display-name">Carregando...</p>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div id="loading-spinner" class="loading-spinner"></div>

        <p id="error-message" class="text-red-500 mt-4" style="display: none;"></p>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://download.playfab.com/PlayFabClientApi.js"></script>

    <script>
        // --- Configuração ---
        const PLAYFAB_TITLE_ID = '12DD32';
        const GOOGLE_CLIENT_ID = '21514234895-keiqos567ifvs4hjkg3l1q5mvun8lri0.apps.googleusercontent.com';

        // --- Elementos da UI ---
        const googleLoginBtn = document.getElementById('google-login-btn');
        const userPanel = document.getElementById('user-panel');
        const userAvatar = document.getElementById('user-avatar');
        const userAvatarPlaceholder = document.getElementById('user-avatar-placeholder');
        const userDisplayName = document.getElementById('user-display-name');
        const userPlayFabId = document.getElementById('user-playfab-id');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessage = document.getElementById('error-message');

        // --- Estado da Aplicação ---
        let isProcessingLogin = false;
        let currentPlayFabId = null;
        // A SDK gerencia o SessionTicket internamente

        // --- Inicialização ---
        window.onload = function() {
            if (typeof PlayFab !== 'undefined' && PlayFab.settings) {
                 PlayFab.settings.titleId = PLAYFAB_TITLE_ID;
                 console.log('PlayFab Title ID configurado:', PlayFab.settings.titleId);
                 initializeGoogleSignIn(); // Inicializa o Google Sign-In
                 checkExistingSession(); // Inicia a verificação de sessão
            } else {
                console.error("Objeto PlayFab ou PlayFab.settings não encontrado!");
                showError("Erro crítico: Não foi possível inicializar o PlayFab.");
            }
        };

        /**
         * Inicializa a nova Google Identity Services Library.
         */
        function initializeGoogleSignIn() {
             if (typeof google === 'undefined' || typeof google.accounts === 'undefined') {
                 console.error('Google Identity Services Library não carregada.');
                 showError('Erro ao carregar o serviço de login do Google.');
                 // Não retorna aqui para permitir que a UI de login PlayFab seja exibida
                 return;
             }

             google.accounts.id.initialize({
                 client_id: GOOGLE_CLIENT_ID,
                 callback: handleGoogleCredentialResponse, // Função chamada após obter a credencial do Google
                 auto_select: false // Desabilita auto-login imediato ao carregar a GSI
             });

             console.log('Google Identity Services inicializado.');
        }

        /**
         * Callback chamada pela Google Identity Services após obter a credencial.
         * @param {object} response O objeto de resposta da Google Identity Services.
         */
        function handleGoogleCredentialResponse(response) {
            console.log('Resposta da Google Identity Services recebida:', response);
            if (response.credential) {
                // O 'credential' aqui é um ID token JWT
                console.log('ID Token do Google obtido:', response.credential);
                // Usamos o ID token para autenticar no PlayFab
                loginWithPlayFab(response.credential);
            } else {
                console.error('Falha ao obter credencial do Google:', response);
                // Se a resposta não tiver credencial, pode ser um cancelamento ou erro.
                // Se o spinner estiver ativo (foi ativado em checkExistingSession ou handleGoogleLogin), desativa.
                 if (loadingSpinner.style.display === 'block') {
                     console.log('Desativando spinner após falha/cancelamento da GSI.');
                     showLoading(false);
                 }
                 // Se está processando login (clique no botão ou tentativa silenciosa), mostra erro.
                 if (isProcessingLogin) {
                     showError('Não foi possível obter o token de acesso do Google.');
                     isProcessingLogin = false;
                     // Se a tentativa foi silenciosa e falhou, mostramos a UI de login.
                     // Se foi manual, a UI de login já está visível.
                     showLoginUI();
                 }
            }
        }


        // --- Funções de UI ---
        function showLoading(isLoading) {
            loadingSpinner.style.display = isLoading ? 'block' : 'none';
            googleLoginBtn.disabled = isLoading;
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = message ? 'block' : 'none';
        }

        function showLoginUI() {
            googleLoginBtn.style.display = 'inline-flex';
            userPanel.style.display = 'none';
            showError('');
            // Limpa os campos de usuário ao mostrar a UI de login
            userDisplayName.textContent = 'Carregando...';
            userPlayFabId.textContent = '';
            userAvatar.style.display = 'none';
            userAvatarPlaceholder.style.display = 'flex';
            userAvatarPlaceholder.textContent = '?';
             showLoading(false); // Garante que o spinner está oculto ao mostrar a UI de login
        }

        function showUserUI(profile) {
            googleLoginBtn.style.display = 'none';
            userPanel.style.display = 'block';
            showError('');

            userDisplayName.textContent = profile?.DisplayName || 'Nome não definido';
            userPlayFabId.textContent = currentPlayFabId || 'N/A';

            if (profile?.AvatarUrl) {
                userAvatar.src = profile.AvatarUrl;
                userAvatar.style.display = 'block';
                userAvatarPlaceholder.style.display = 'none';
                userAvatar.onerror = () => {
                    userAvatar.style.display = 'none';
                    userAvatarPlaceholder.style.display = 'flex';
                    userAvatarPlaceholder.textContent = profile.DisplayName ? profile.DisplayName.charAt(0).toUpperCase() : '?';
                };
            } else {
                userAvatar.style.display = 'none';
                userAvatarPlaceholder.style.display = 'flex';
                userAvatarPlaceholder.textContent = profile?.DisplayName ? profile.DisplayName.charAt(0).toUpperCase() : '?';
            }
             showLoading(false); // Garante que o spinner está oculto ao mostrar a UI do usuário
        }

        // --- Lógica de Autenticação e PlayFab ---

        /**
         * Verifica se existe um playfabId salvo no localStorage.
         * Se sim, tenta um login silencioso com Google para re-autenticar no PlayFab.
         * Caso contrário, exibe a UI de login.
         */
        function checkExistingSession() {
            currentPlayFabId = localStorage.getItem('playfabId'); // Tenta carregar o último ID conhecido

            console.log('checkExistingSession: Verificando sessão...');
            console.log('checkExistingSession: localStorage playfabId:', currentPlayFabId);

            // Não confiamos mais apenas em PlayFabClientSDK.IsClientLoggedIn() ao carregar a página
            // para determinar se a sessão persiste, pois vimos que ela pode não reconhecer
            // a sessão após recarregar, mesmo que o ticket seja válido.
            // A re-autenticação via Google é a forma mais segura.

            if (currentPlayFabId) {
                 console.log(`checkExistingSession: PlayFabId (${currentPlayFabId}) encontrado no localStorage. Tentando login silencioso com Google para re-autenticar no PlayFab...`);
                 showLoading(true); // Ativa o spinner para a tentativa de login silencioso
                 attemptSilentGoogleLogin();
            }
             else {
                 console.log('checkExistingSession: Nenhum PlayFabId no localStorage. Exibindo tela de login.');
                 showLoginUI(); // showLoginUI garante que o spinner está oculto
            }
        }

        /**
         * Tenta realizar um login silencioso com o Google Identity Services.
         */
        function attemptSilentGoogleLogin() {
             if (typeof google === 'undefined' || typeof google.accounts === 'undefined' || typeof google.accounts.id === 'undefined') {
                 console.error('Google Identity Services Library não inicializada para login silencioso.');
                 showError('Erro no serviço de login do Google.');
                 showLoginUI(); // Fallback para UI de login padrão
                 return;
             }

             // Use google.accounts.id.prompt() para tentar um login silencioso/one-tap.
             // O callback handleGoogleCredentialResponse será chamado se uma credencial for obtida.
             // A notificação permite saber se o prompt foi dispensado sem credencial.
             console.log('Tentando google.accounts.id.prompt() para login silencioso...');
             google.accounts.id.prompt((notification) => {
                 console.log('Google prompt notification:', notification);
                 // Se o prompt for dispensado ou pulado, o login silencioso não ocorreu com sucesso.
                 // handleGoogleCredentialResponse NÃO será chamado neste caso.
                 if (notification.isDismissed || notification.isSkipped) {
                     console.log('Google prompt dismissed ou skipped. Login silencioso falhou.');
                      // Se o spinner estiver ativo (foi ativado em checkExistingSession), desativa e mostra a UI de login.
                      if (loadingSpinner.style.display === 'block') {
                         console.log('Desativando spinner após Google prompt dismissed/skipped.');
                         showLoading(false);
                         showLoginUI(); // Mostra a UI de login padrão
                      }
                 }
                 // Se a notificação for 'granted', handleGoogleCredentialResponse já foi/será chamado com a credencial.
                 // Se for 'denied', handleGoogleCredentialResponse será chamado com um erro (sem credencial).
             });
        }


        /**
         * Inicia o fluxo de login com o Google (chamado pelo clique no botão).
         */
        function handleGoogleLogin() {
            if (isProcessingLogin) return;
            isProcessingLogin = true;
            showLoading(true);
            showError('');

             if (typeof google === 'undefined' || typeof google.accounts === 'undefined' || typeof google.accounts.id === 'undefined') {
                 console.error('Google Identity Services Library não inicializada para login manual.');
                 showError('Erro no serviço de login do Google.');
                 isProcessingLogin = false;
                 showLoading(false);
                 return;
             }

            console.log('Iniciando fluxo de login manual com Google via google.accounts.id.prompt()...');
            // Chama o prompt GSI. O fluxo continua em handleGoogleCredentialResponse.
            google.accounts.id.prompt();
            // Nota: A notificação do prompt para um login manual (clique no botão)
            // geralmente não indica "dismissed" ou "skipped" a menos que o usuário
            // feche explicitamente a janela ou popup do Google. O callback
            // handleGoogleCredentialResponse tratará o sucesso ou falha.
        }

        /**
         * Realiza o login no PlayFab usando o ID Token do Google (credential).
         * @param {string} googleIdToken O ID Token JWT obtido do Google.
         */
        function loginWithPlayFab(googleIdToken) {
            console.log('Tentando login no PlayFab com ID Token do Google...');
             // Certifica-se que o spinner está ativo, caso não tenha sido ativado antes (ex: login manual)
             showLoading(true);


            const loginRequest = {
                // PlayFab Client SDK LoginWithGoogleAccount espera o ID Token JWT no campo AccessToken
                AccessToken: googleIdToken,
                CreateAccount: true,
                InfoRequestParameters: {
                    GetPlayerProfile: true,
                    ProfileConstraints: {
                       ShowDisplayName: true,
                       ShowAvatarUrl: true
                    }
                }
            };

            PlayFabClientSDK.LoginWithGoogleAccount(loginRequest, (responseObject, errorDetails) => {
                isProcessingLogin = false;
                showLoading(false); // Garante que o spinner é oculto após a tentativa de login

                if (responseObject && responseObject.code === 200 && responseObject.data && responseObject.data.SessionTicket) {
                    console.log('Login PlayFab bem-sucedido!', responseObject.data);
                    currentPlayFabId = responseObject.data.PlayFabId;

                    // Armazena o PlayFabId para exibição e referência futura
                    localStorage.setItem('playfabId', currentPlayFabId);
                    // A SDK gerencia o SessionTicket internamente

                    const initialProfile = responseObject.data.InfoResultPayload?.PlayerProfile;
                    showUserUI(initialProfile); // Mostra UI com dados do perfil obtido no login

                } else {
                    console.error('Erro no login PlayFab com Google:', responseObject, errorDetails);
                    const errorMessageText = responseObject?.errorMessage || responseObject?.status || 'Erro desconhecido';
                    const errorCodeValue = responseObject?.errorCode || 'N/A';
                    showError(`Falha no login PlayFab: ${errorMessageText} (Código: ${errorCodeValue})`);
                    // Se o login falhou, garantimos que a UI de login seja mostrada
                    showLoginUI();
                }
            });
        }


        /**
         * Carrega o perfil do jogador do PlayFab.
         * Esta função agora é chamada APENAS após um login BEM-SUCEDIDO (inicial ou re-autenticação).
         * Não é mais usada para tentar restaurar a sessão.
         */
        // Removida a função loadPlayFabUserProfile, pois as informações de perfil
        // já são obtidas no LoginWithGoogleAccount response com InfoRequestParameters.
        // Se precisarmos carregar informações adicionais do perfil mais tarde,
        // podemos criar uma nova função para isso, mas não para a persistência inicial.


        /**
         * Realiza o logout, limpando o localStorage e redefinindo a UI.
         * Também tenta fazer logout do Google.
         */
        function logout() {
            console.log('Realizando logout...');
            // Limpa o PlayFabId do localStorage
            localStorage.removeItem('playfabId');

            // Reseta variáveis de estado
            currentPlayFabId = null;

            // Tenta fazer logout do Google também, se a biblioteca estiver carregada
             if (typeof google !== 'undefined' && typeof google.accounts !== 'undefined' && typeof google.accounts.id !== 'undefined') {
                 console.log('Tentando logout do Google...');
                 // disableAutoSelect impede o login automático na próxima carga
                 google.accounts.id.disableAutoSelect();
                 // Para um logout mais completo do Google (se aplicável ao seu caso de uso),
                 // você pode precisar de google.accounts.id.revoke, mas isso geralmente
                 // requer a permissão do usuário e a informação da conta Google logada.
                 // disableAutoSelect é suficiente para impedir a re-autenticação automática na GSI.
             }


            // Reseta UI
            showLoginUI(); // showLoginUI garante que o spinner está oculto
            console.log('Logout concluído.');
        }

         // Reconfigura o botão de login para usar o novo fluxo GSI prompt
         // Isso é feito aqui fora do onload para garantir que o listener seja adicionado
         // assim que o script for parseado, antes mesmo do DOM estar completamente pronto,
         // caso o usuário clique muito rápido. O initializeGoogleSignIn no onload
         // garante que 'google.accounts.id' esteja disponível.
         if (googleLoginBtn) {
             googleLoginBtn.onclick = handleGoogleLogin; // Atribui a função handleGoogleLogin ao clique
             console.log('Botão de login reconfigurado para usar handleGoogleLogin (que chama google.accounts.id.prompt()).');
         }


    </script>
</body>
</html>
