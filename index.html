<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login with Google - PlayFab</title>
    <style>
        /* Estilos anteriores mantidos */
        body { /* ... */ }
        .login-container { /* ... */ }
        .google-btn { /* ... */ }
        .google-btn:hover { /* ... */ }
        .google-icon { /* ... */ }

        /* Novos estilos */
        .user-panel {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        .logout-btn {
            background-color: #dc3545;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <h2>Login with Google</h2>
        <button class="google-btn" onclick="handleGoogleLogin()">
            <img src="https://developers.google.com/identity/images/g-logo.png" 
                 alt="Google logo" 
                 class="google-icon">
            Continue with Google
        </button>
        
        <div class="user-panel">
            <h3>Bem-vindo, <span id="username"></span>!</h3>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Scripts anteriores mantidos -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://download.playfab.com/PlayFabClientApi.js"></script>

    <script>
        const titleId = '12DD32';
        let isProcessing = false;

        // Verifica se j치 est치 logado ao carregar a p치gina
        window.onload = function() {
            checkExistingSession();
        };

        function checkExistingSession() {
            const sessionTicket = localStorage.getItem('playfabSessionTicket');
            if(sessionTicket) {
                loadUserProfile(sessionTicket);
            }
        }

        function handleGoogleLogin() {
            if(isProcessing) return;
            isProcessing = true;
            
            const client = google.accounts.oauth2.initTokenClient({
                client_id: '21514234895-keiqos567ifvs4hjkg3l1q5mvun8lri0.apps.googleusercontent.com',
                scope: 'email profile openid',
                callback: (response) => {
                    if (response.access_token) {
                        loginWithPlayFab(response.access_token);
                    } else {
                        alert('Falha ao obter token do Google');
                        isProcessing = false;
                    }
                },
                error: (error) => {
                    console.error('Erro Google:', error);
                    alert('Erro: ' + error.message);
                    isProcessing = false;
                }
            });
            client.requestAccessToken();
        }

        function loginWithPlayFab(googleAccessToken) {
            const request = {
                TitleId: titleId,
                AccessToken: googleAccessToken,
                CreateAccount: true,
                InfoRequestParameters: {
                    GetPlayerProfile: true
                }
            };

            PlayFabClientSDK.LoginWithGoogleAccount(request, (error, result) => {
                const response = error || result;
                isProcessing = false;

                if (response?.data?.SessionTicket) {
                    // Salva os dados no localStorage
                    localStorage.setItem('playfabSessionTicket', response.data.SessionTicket);
                    localStorage.setItem('playfabUserData', JSON.stringify(response.data));

                    // Atualiza a UI
                    showUserInfo(response.data);
                } else {
                    const errorMsg = response?.data?.errorMessage || 'Erro desconhecido';
                    alert(`Falha: ${errorMsg}`);
                }
            });
        }

        function showUserInfo(userData) {
            document.querySelector('.google-btn').style.display = 'none';
            const userPanel = document.querySelector('.user-panel');
            const usernameSpan = document.getElementById('username');

            // Tenta obter o nome do perfil
            const username = userData?.InfoResultPayload?.PlayerProfile?.DisplayName || 
                           userData?.EntityToken?.Entity?.Id || 
                           'Usu치rio';

            usernameSpan.textContent = username;
            userPanel.style.display = 'block';
        }

        function loadUserProfile(sessionTicket) {
            const request = {
                SessionTicket: sessionTicket,
                InfoRequestParameters: {
                    GetPlayerProfile: true
                }
            };

            PlayFabClientSDK.GetPlayerProfile(request, (error, result) => {
                if(result?.data?.PlayerProfile) {
                    showUserInfo({
                        InfoResultPayload: {
                            PlayerProfile: result.data.PlayerProfile
                        }
                    });
                }
            });
        }

        function logout() {
            localStorage.removeItem('playfabSessionTicket');
            localStorage.removeItem('playfabUserData');
            document.querySelector('.google-btn').style.display = 'flex';
            document.querySelector('.user-panel').style.display = 'none';
        }
    </script>
</body>
</html>
